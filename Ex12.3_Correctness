Precedence 100 for: _â€¥_
Non-associating: _â€¥_
Declaration: _â€¥_ : â„• â†’ â„• â†’ set â„•

Axiom â€œDefinition of â€¥â€:  m â€¥ n  =  { i â™ m â‰¤ i â‰¤ n }

Theorem â€œMembership in â€¥â€:  i âˆˆ m â€¥ n  â‰¡  m â‰¤ i â‰¤ n
Proof:
    i âˆˆ m â€¥ n
  =âŸ¨ â€œDefinition of â€¥â€ âŸ©
    i âˆˆ { a â™ m â‰¤ a â‰¤ n }
  =âŸ¨ â€œSimple membershipâ€ âŸ©
    (m â‰¤ a â‰¤ n)[a â‰” i]
  =âŸ¨ Substitution âŸ©   
     m â‰¤ i â‰¤ n

Theorem â€œMembership in 0 â€¥â€:  i âˆˆ 0 â€¥ n  â‰¡  i â‰¤ n
Proof:
    i âˆˆ 0 â€¥ n
  =âŸ¨ â€œMembership in â€¥â€ âŸ©
    0 â‰¤ i â‰¤ n
  =âŸ¨ â€œZero is least elementâ€, â€œIdentity of âˆ§â€ âŸ©
    i â‰¤ n  

Precedence 97 for: _â‡´_
Associating to the right: _â‡´_
Declaration: _â‡´_ : set A â†’ set B â†’ set (A â†” B)

Axiom â€œDefinition of â‡´â€:
  X â‡´ Y  =  { f â™ f Ë˜ â¨¾ f âŠ† id Y  âˆ§  Dom f = X }

The type of length-(k + 1) arrays with element type A can then be modeled as the following set:
    (0 â€¥ k) â‡´ âŒ A âŒŸ
Array lookup a[i] then is just partial function application, as seen in A6.2:
   a @ i
Array update a[i] := E can be formalised via relation override _âŠ•_ (seen in Ex9,4):
    a := a âŠ• { âŸ¨ i , E âŸ© }
There is no easier way to reason about array manipulations in Hoare logic!


Using conventional array notation, the program in the following theorem would look as follows:
    z := xs[i] â®
    xs[i] := xs[j] â®
    xs[j] := z
To prove this correctness theorem, you may need to prove additional properties beyond what is provided in Ref9.2 about âŠ• etc.:


Lemma â€œDom of singleton relationâ€: Dom { âŸ¨ i, j âŸ© } = { i }
Proof:
  Using â€œSet extensionalityâ€:
    For any `x`:
        x âˆˆ Dom { âŸ¨ i, j âŸ© }
      =âŸ¨ â€œMembership in `Dom`â€ âŸ©
        âˆƒ y â€¢ x â¦— { âŸ¨ i, j âŸ© } â¦˜ y
      =âŸ¨ â€œSingleton relationâ€ âŸ©
        âˆƒ y â€¢ x = i âˆ§ j = y
      =âŸ¨ â€œTrading for âˆƒâ€, â€œOne-point rule for âˆƒâ€ âŸ©
        (x = i)[y â‰” j] 
      =âŸ¨ Substitution âŸ©
         x = i  
      =âŸ¨ â€œSingleton set membershipâ€ âŸ© 
        x âˆˆ { i }

Lemma â€œIdempotency of âŠ•â€: R âŠ• R = R
Proof:
  Using â€œRelation extensionalityâ€:
    For any `x`, `y`:
        x â¦— R âŠ• R â¦˜ y
      =âŸ¨ â€œRelation overrideâ€ âŸ©
        (Â¬ (x âˆˆ Dom R) âˆ§ x â¦— R â¦˜ y) âˆ¨ x â¦— R â¦˜ y
      =âŸ¨ â€œAbsorptionâ€ (3.43b) âŸ©
        x â¦— R â¦˜ y

Lemma â€œRepeated âŠ•â€: (R âŠ• S) âŠ• S = R âŠ• S
Proof:
    (R âŠ• S) âŠ• S
  =âŸ¨ â€œAssociativity of âŠ•â€ âŸ©
    R âŠ• (S âŠ• S)
  =âŸ¨ â€œIdempotency of âŠ•â€ âŸ©
    R âŠ• S

Theorem â€œSingletons âŠ•â€:
    Â¬ (i = j)  â‡’  { âŸ¨ i, x âŸ© } âŠ• { âŸ¨ j, y âŸ© }
                = { âŸ¨ i , x âŸ©, âŸ¨ j , y âŸ© }
Proof:
  Assuming `Â¬ (i = j)`:
    Side proof for (1) `Dom { âŸ¨ j, y âŸ© } â©¤ { âŸ¨ i, x âŸ© } = { âŸ¨ i, x âŸ© }`:
      Using â€œRelation extensionalityâ€:
        For any `a`, `b`:
            a â¦— Dom { âŸ¨ j, y âŸ© } â©¤ { âŸ¨ i, x âŸ© } â¦˜ b
          â‰¡âŸ¨ â€œDom of singleton relationâ€ âŸ©
            a â¦— { j } â©¤ { âŸ¨ i, x âŸ© } â¦˜ b
          â‰¡ âŸ¨ â€œRelationship via â©¤â€ âŸ© 
            Â¬ (a âˆˆ { j }) âˆ§ a â¦— { âŸ¨ i, x âŸ© } â¦˜ b
          â‰¡âŸ¨ â€œSingleton set membershipâ€, â€œSingleton relationâ€ âŸ©
            Â¬ (a = j) âˆ§ a = i âˆ§ x = b
          â‰¡âŸ¨ Substitution âŸ©
            (Â¬ (a = j))[a â‰” a] âˆ§ a = i âˆ§ x = b
          â‰¡âŸ¨ â€œReplacementâ€, substitution âŸ©
            (Â¬ (i = j)) âˆ§ a = i âˆ§ x = b
          â‰¡âŸ¨ Assumption `Â¬ (i = j)`, â€œIdentity of âˆ§â€ âŸ©
            a = i âˆ§ x = b
          â‰¡âŸ¨ â€œSingleton relationâ€ âŸ©
            a â¦— { âŸ¨ i, x âŸ© } â¦˜ b
    Continuing:
        { âŸ¨ i, x âŸ© } âŠ• { âŸ¨ j, y âŸ© }
      =âŸ¨ â€œDefinition of âŠ•â€ âŸ©
        (Dom { âŸ¨ j, y âŸ© } â©¤ { âŸ¨ i, x âŸ© }) âˆª { âŸ¨ j, y âŸ© }
      =âŸ¨ Local property (1) âŸ©
        { âŸ¨ i , x âŸ© } âˆª { âŸ¨ j , y âŸ© }
      =âŸ¨ â€œSet extensionalityâ€ with subproof:
          For any `p`:
              p âˆˆ { âŸ¨ i , x âŸ© } âˆª { âŸ¨ j , y âŸ© }
            â‰¡âŸ¨ â€œUnionâ€, â€œSingleton set membershipâ€ âŸ©
              p = âŸ¨ i , x âŸ© âˆ¨ p = âŸ¨ j , y âŸ©
            â‰¡âŸ¨ â€œSimple membershipâ€, substitution âŸ©
              p âˆˆ { âŸ¨ i , x âŸ©, âŸ¨ j , y âŸ© }
        âŸ©
        { âŸ¨ i , x âŸ©, âŸ¨ j , y âŸ© }

Theorem â€œArray swapâ€:
       i â‰¤ k â‰¥ j  âˆ§  xs = xsâ‚€ âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ
    â‡’â… z := xs @ i â®
       xs := xs âŠ• { âŸ¨ i, xs @ j âŸ© } â®
       xs := xs âŠ• { âŸ¨ j, z âŸ© }
     â†
      xs = xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
Proof:
      xs = xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
  â… xs := xs âŠ• { âŸ¨ j, z âŸ© } â†â‡ âŸ¨ â€œAssignmentâ€ with substitution âŸ©
      xs âŠ• { âŸ¨ j, z âŸ© } = xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
  â… xs := xs âŠ• { âŸ¨ i, xs @ j âŸ© } â†â‡ âŸ¨ â€œAssignmentâ€ with substitution âŸ©
      (xs  âŠ• { âŸ¨ i, xs @ j âŸ© }) âŠ• { âŸ¨ j, z âŸ© } = xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
  â… z := xs @ i â†â‡ âŸ¨ â€œAssignmentâ€ with substitution âŸ©
      (xs  âŠ• { âŸ¨ i, xs @ j âŸ© }) âŠ• { âŸ¨ j, xs @ i âŸ© } = xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
  â‡âŸ¨ Subproof:
      Assuming (1) `i â‰¤ k â‰¥ j  âˆ§  xs = xsâ‚€ âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ`:
        By cases: `i = j`, `Â¬ (i = j)`
          Completeness: By â€œLEMâ€
          Case `i = j`:
              (xs  âŠ• { âŸ¨ i, xs @ j âŸ© }) âŠ• { âŸ¨ j, xs @ i âŸ© }
            =âŸ¨ Assumption `i = j` âŸ©
              (xs  âŠ• { âŸ¨ i, xs @ i âŸ© }) âŠ• { âŸ¨ i, xs @ i âŸ© }
            =âŸ¨ â€œRepeated âŠ•â€, assumption (1) âŸ©
              xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ i âŸ© }
            =âŸ¨ â€œIdempotency of âˆ¨â€ âŸ©
              xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ i âŸ©, âŸ¨ i , xsâ‚€ @ i âŸ© }
            =âŸ¨ Assumption `i = j` âŸ©
              xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
          Case `Â¬ (i = j)`:
              (xs  âŠ• { âŸ¨ i, xs @ j âŸ© }) âŠ• { âŸ¨ j, xs @ i âŸ© }
            =âŸ¨ â€œAssociativity of âŠ•â€ âŸ©
              xs  âŠ• ({ âŸ¨ i, xs @ j âŸ© } âŠ• { âŸ¨ j, xs @ i âŸ© })
            =âŸ¨ â€œSingletons âŠ•â€ with assumption `Â¬ (i = j)`, assumption (1) âŸ©
              xsâ‚€ âŠ• { âŸ¨ i , xsâ‚€ @ j âŸ©, âŸ¨ j , xsâ‚€ @ i âŸ© }
    âŸ©
    i â‰¤ k â‰¥ j  âˆ§  xs = xsâ‚€ âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ

Declaration: sorted : (â„• â†” â„•) â†’ ğ”¹
Axiom â€œDefinition of `sorted`â€:
    sorted R   â‰¡   âˆ€ i â€¢ âˆ€ j â™ i < j â€¢ âˆ€ m â€¢ âˆ€ n â™ i â¦— R â¦˜ m âˆ§ j â¦— R â¦˜ n â€¢ m â‰¤ n

Theorem â€œSorting 0â€:
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ
  â‡’â…  p := 0 â®
      while p â‰  k do
        xs := xs âŠ• { âŸ¨ p, 42 âŸ© } â®
        p := p + 1
      od
    â†
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted xs
Proof:
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ
  â‡’âŸ¨ ? âŸ©
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted ((0 â€¥ 0) â— xs)
  â‡’â… p := 0 â† âŸ¨ â€œAssignmentâ€ with substitution âŸ©
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted ((0 â€¥ p) â— xs)
      âˆ§ ?
  â‡’â… while p â‰  k do
        xs := xs âŠ• { âŸ¨ p, 42 âŸ© } â®
        p := p + 1
      od
    â† âŸ¨ â€œWhileâ€ with subproof:
          ?
    âŸ©
    Â¬ (p â‰  k) âˆ§  xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted ((0 â€¥ p) â— xs)
      âˆ§ ?
  â‡’âŸ¨ ? âŸ©
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted xs

Theorem â€œSorting 0'â€:
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ
  â‡’â… while true do
        xs := xs âŠ• { âŸ¨ 0, 42 âŸ© }
      od
    â†
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted xs
      âˆ§ âŸ… p â™ p âˆˆ xs â€¢ snd p âŸ† = âŸ… p â™ p âˆˆ xsâ‚€ â€¢ snd p âŸ†
Proof:
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ
  â‡’âŸ¨ â€œRight-zero of â‡’â€ âŸ©
    true
  â‡’â… while true do
        xs := xs âŠ• { âŸ¨ 0, 42 âŸ© }
     od â† âŸ¨ â€œWhileâ€ with subproof:
               true âˆ§ true
             =âŸ¨ â€œIdempotency of âˆ§â€ âŸ©
               true 
             â‡’â… xs := xs âŠ• { âŸ¨ 0, 42 âŸ© } â†âŸ¨ â€œAssignmentâ€ with Substitution âŸ©
               true            
    âŸ©
    Â¬ true âˆ§ true
  =âŸ¨ â€œContradictionâ€ âŸ©
    false
  â‡’âŸ¨ â€œex falso quodlibetâ€ âŸ©  
    xs âˆˆ (0 â€¥ k) â‡´ âŒ â„• âŒŸ  âˆ§  sorted xs
      âˆ§ âŸ… p â™ p âˆˆ xs â€¢ snd p âŸ† = âŸ… p â™ p âˆˆ xsâ‚€ â€¢ snd p âŸ† 
